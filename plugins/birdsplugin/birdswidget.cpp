#include "birdswidget.h"
#include "ui_birdswidget.h"

#include <QDebug>

#include <QGraphicsPixmapItem>

#include <qmath.h>
#include <QTime>

#include "normalanimation.h"

BirdsWidget::BirdsWidget(QWidget *parent) :
    QWidget(parent)
    , _ui(new Ui::BirdsWidget)
    , _scene(new QGraphicsScene(0, 0, 320, 240))
    , _timer(new QTimer)
  , _flukso(new Flukso())
  , _animation(new NormalAnimation(_scene, _flukso->displaySensor()))
{
    _ui->setupUi(this);
    qsrand(QTime::currentTime().msec());

    _ui->view->setAlignment(Qt::AlignTop | Qt::AlignLeft);
    _ui->view->setRenderHints(QPainter::Antialiasing);
    _ui->view->show();

    animate();

    _timer->setInterval(50);
    connect(_timer, SIGNAL(timeout()), _animation, SLOT(step()));
    _timer->start();

    connect(_flukso, SIGNAL(valueChanged(QString, int)), _animation, SLOT(setValue(QString, int)));
    connect(_flukso, SIGNAL(errorOccured(QString)), _animation, SLOT(setError(QString)));
}

BirdsWidget::~BirdsWidget()
{
    delete _ui;
}

void BirdsWidget::animate()
{
    _animation->reset();

    _ui->view->setScene(_scene);
}

void BirdsWidget::paintEvent(QPaintEvent *)
{
    _ui->view->ensureVisible(_scene->sceneRect());
    // remove the mysterious border generated by fitInView by adjusting the sceneRect
    QRectF rect(_scene->sceneRect());
    _ui->view->fitInView(QRectF(rect.x(), rect.y(), rect.width()-6, rect.height()-6), Qt::KeepAspectRatio);
}
